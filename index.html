<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Invoice Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family: Arial, sans-serif;
  background:#f5f5f5;
  padding:20px;
}
.container{
  max-width:520px;
  margin:auto;
  background:#fff;
  padding:20px;
  border-radius:8px;
  box-shadow:0 0 10px rgba(0,0,0,.1);
}
label{
  font-weight:bold;
  margin-top:12px;
  display:block;
}
input, select{
  width:100%;
  height:42px;
  margin-top:5px;
  padding:8px;
  font-size:15px;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:18px;
}
th, td{
  border:1px solid #ddd;
  padding:8px;
  text-align:center;
}
th{
  background:#007bff;
  color:#fff;
}
.total{
  font-weight:bold;
  background:#f0f0f0;
}
</style>
</head>

<body>

<div class="container">
  <h3>Invoice Lookup</h3>

  <label>Select Date</label>
  <input type="date" id="date" onchange="loadInvoices()">

  <label>Select Invoice</label>
  <select id="invoice" onchange="loadItems()">
    <option value="">-- Select Invoice --</option>
  </select>

  <table id="itemsTable" style="display:none">
    <thead>
      <tr>
        <th>Item</th>
        <th>Qty</th>
        <th>Price</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwu6tvrXKAmaZSnqcrb3myGAvW3CmPwnUUfa57M7eg7KOJzys2ZPZWx82AL0EbxhEAmFQ/exec";

// yyyy-mm-dd â†’ d/M/yyyy
function formatDate(input) {
  const d = new Date(input);
  return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
}

function loadInvoices() {
  const dateInput = document.getElementById("date").value;
  const invoiceSelect = document.getElementById("invoice");

  invoiceSelect.innerHTML = "<option>Loading...</option>";
  if (!dateInput) return;

  fetch(`${API_URL}?action=getInvoices&date=${formatDate(dateInput)}`)
    .then(res => res.json())
    .then(data => {
      invoiceSelect.innerHTML = `<option value="">-- Select Invoice --</option>`;
      if (data.length === 0) {
        invoiceSelect.innerHTML += `<option>No invoices found</option>`;
      }
      data.forEach(inv => {
        invoiceSelect.innerHTML += `<option value="${inv}">${inv}</option>`;
      });
    });
}

function loadItems() {
  const invoiceNo = document.getElementById("invoice").value;
  const table = document.getElementById("itemsTable");
  const tbody = table.querySelector("tbody");

  if (!invoiceNo) {
    table.style.display = "none";
    return;
  }

  fetch(`${API_URL}?action=getItems&invoiceNo=${invoiceNo}`)
    .then(res => res.json())
    .then(items => {
      tbody.innerHTML = "";
      let grandTotal = 0;

      items.forEach(i => {
        grandTotal += i.total;
        tbody.innerHTML += `
          <tr>
            <td>${i.item}</td>
            <td>${i.qty}</td>
            <td>${i.price}</td>
            <td>${i.total}</td>
          </tr>`;
      });

      tbody.innerHTML += `
        <tr class="total">
          <td colspan="3">Grand Total</td>
          <td>${grandTotal}</td>
        </tr>
      `;

      table.style.display = "table";
    });
}
</script>

</body>
</html>
