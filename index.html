<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Invoice Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:"Segoe UI", Arial, sans-serif;
  background:#eef1f5;
  padding:16px;
  margin:0;
}
.container{
  max-width:560px;
  margin:auto;
  background:#fff;
  padding:20px;
  border-radius:14px;
  box-shadow:0 12px 30px rgba(0,0,0,.08);
}
h3{text-align:center;margin-bottom:16px}

.center-block{
  display:flex;
  justify-content:center;
  margin-bottom:12px;
}
.center-block input,
.center-block select{
  width:260px;
  height:46px;
  text-align:center;
  font-size:16px;
  border-radius:10px;
  border:1px solid #ccc;
}

button{
  border:none;
  border-radius:8px;
  padding:12px 16px;
  font-size:15px;
  cursor:pointer;
}
.success{background:#28a745;color:#fff}
.danger{background:#dc3545;color:#fff}
.secondary{background:#007bff;color:#fff}
.ghost{background:#f1f3f5}

.actions{
  display:flex;
  gap:10px;
  margin-top:14px;
  justify-content:center;
  flex-wrap:wrap;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:12px;
  font-size:14px;
}
th{
  background:#f6f7f9;
}
th,td{
  border:1px solid #e3e3e3;
  padding:8px;
  text-align:center;
}

.grand-total{
  margin-top:12px;
  font-size:16px;
  font-weight:600;
  text-align:right;
}

.hidden{display:none}

/* Add Item */
.add-item{
  margin-top:18px;
  padding:14px;
  background:#f7f9fc;
  border-radius:12px;
  border:1px solid #e1e6ee;
}
.add-item input{
  width:100%;
  height:46px;
  font-size:16px;
  padding:10px;
  border-radius:8px;
  border:1px solid #ccc;
  margin-top:10px;
}
.row-2{
  display:flex;
  gap:10px;
}
.row-2 input{flex:1}
.helper{font-size:12px;color:#666;margin-top:6px}
</style>
</head>

<body>

<div class="container">
  <h3>üßæ Invoice Lookup</h3>

  <div class="center-block">
    <input type="date" id="date" onchange="loadInvoices()">
  </div>

  <div class="center-block">
    <select id="invoice" disabled onchange="loadItems()">
      <option>Select date first</option>
    </select>
  </div>

  <div class="actions">
    <button class="secondary" onclick="toggleAddItem()">‚ûï Add Item</button>
    <button class="danger" onclick="deleteInvoice()">üóë Delete Invoice</button>
  </div>

  <table id="itemsTable" class="hidden">
    <thead>
      <tr>
        <th>Item</th>
        <th>Qty</th>
        <th>Price</th>
        <th>Total</th>
        <th>‚ùå</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="grandTotal" class="grand-total hidden">
    Grand Total: ‚Çπ<span id="grandTotalValue">0</span>
  </div>

  <div id="addItemSection" class="add-item hidden">
    <input id="item" placeholder="Item name">
    <div class="row-2">
      <input id="qty" type="number" placeholder="Quantity" oninput="calcFromQtyPrice()">
      <input id="price" type="number" placeholder="Price" oninput="calcFromQtyPrice()">
    </div>
    <input id="total" type="number" placeholder="Total" oninput="calcFromTotal()">
    <div class="helper">Enter Price or Total ‚Äî the other auto-calculates</div>
    <div class="actions">
      <button class="success" onclick="confirmAddItem()">Save Item</button>
      <button class="ghost" onclick="toggleAddItem()">Cancel</button>
    </div>
  </div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbzOJH7NE5utvZ4Fa4np4HSfg-xfS---mU_ts3yCG5dlJUzVd1WRMTjAOXv5ziZjK9u0VQ/exec";

function formatDate(v){
  const d=new Date(v);
  return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
}

function toggleAddItem(){
  addItemSection.classList.toggle("hidden");
}

function loadInvoices(){
  if(!date.value) return;
  invoice.disabled=true;
  invoice.innerHTML=`<option>Loading bills...</option>`;
  fetch(`${API}?action=getInvoices&date=${formatDate(date.value)}`)
    .then(r=>r.json())
    .then(d=>{
      invoice.innerHTML="";
      if(!d.length){
        invoice.innerHTML=`<option>No bills found</option>`;
        return;
      }
      invoice.innerHTML=`<option value="">-- Select Invoice --</option>`;
      d.forEach(b=>invoice.innerHTML+=`<option>${b}</option>`);
      invoice.disabled=false;
    });
}

function loadItems(){
  if(!invoice.value) return;
  fetch(`${API}?action=getItems&invoiceNo=${invoice.value}`)
    .then(r=>r.json())
    .then(items=>{
      let g=0;
      const tbody=itemsTable.querySelector("tbody");
      tbody.innerHTML="";
      items.forEach(i=>{
        g+=Number(i.total);
        tbody.innerHTML+=`
        <tr>
          <td>${i.item}</td>
          <td>${i.qty}</td>
          <td>${i.price}</td>
          <td>${i.total}</td>
          <td><button class="ghost" onclick="deleteItem(${i.row},this)">‚ùå</button></td>
        </tr>`;
      });
      itemsTable.classList.remove("hidden");
      grandTotal.classList.remove("hidden");
      grandTotalValue.innerText=g.toFixed(2);
    });
}

/* üî¥ DELETE ITEM CONFIRMATION */
function deleteItem(row,btn){
  const tr=btn.closest("tr");
  const item=tr.children[0].innerText;
  const qty=tr.children[1].innerText;
  const price=tr.children[2].innerText;
  const total=tr.children[3].innerText;

  const ok=confirm(
    `You are about to delete this item:\n\n`+
    `Item Name : ${item}\n`+
    `Quantity  : ${qty}\n`+
    `Price     : ‚Çπ${price}\n`+
    `Total     : ‚Çπ${total}\n\n`+
    `This action cannot be undone.\n\nContinue?`
  );
  if(!ok) return;

  fetch(`${API}?action=deleteItem&row=${row}`).then(loadItems);
}

/* üî¥ DELETE INVOICE CONFIRMATION */
function deleteInvoice(){
  if(!invoice.value) return alert("Select invoice");
  const count=itemsTable.querySelectorAll("tbody tr").length;
  const total=grandTotalValue.innerText;

  const ok=confirm(
    `You are about to delete the ENTIRE invoice:\n\n`+
    `Invoice No : ${invoice.value}\n`+
    `Total Items: ${count}\n`+
    `Grand Total: ‚Çπ${total}\n\n`+
    `All items will be permanently deleted.\n\nProceed?`
  );
  if(!ok) return;

  fetch(`${API}?action=deleteInvoice&billNo=${encodeURIComponent(invoice.value)}`)
    .then(()=>{
      itemsTable.classList.add("hidden");
      grandTotal.classList.add("hidden");
      loadInvoices();
    });
}

/* üßÆ Calculations */
function calcFromQtyPrice(){
  if(qty.value && price.value)
    total.value=(qty.value*price.value).toFixed(2);
}
function calcFromTotal(){
  if(qty.value && total.value)
    price.value=(total.value/qty.value).toFixed(2);
}

/* üü¢ ADD ITEM CONFIRMATION */
function confirmAddItem(){
  if(!invoice.value||!item.value||!qty.value||!date.value){
    return alert("Fill all required fields");
  }

  const finalPrice = price.value || (total.value/qty.value);
  const finalTotal = (qty.value * finalPrice).toFixed(2);

  const ok = confirm(
    `You are about to add this item:\n\n`+
    `Item Name : ${item.value}\n`+
    `Quantity  : ${qty.value}\n`+
    `Price     : ‚Çπ${Number(finalPrice).toFixed(2)}\n`+
    `Total     : ‚Çπ${finalTotal}\n`+
    `Invoice   : ${invoice.value}\n\n`+
    `Do you want to continue?`
  );

  if(!ok) return;

  addItem(finalPrice);
}

/* ‚úÖ ACTUAL ADD */
function addItem(finalPrice){
  fetch(
    `${API}?action=addItem&billNo=${encodeURIComponent(invoice.value)}`+
    `&item=${encodeURIComponent(item.value)}`+
    `&qty=${qty.value}`+
    `&price=${finalPrice}`+
    `&date=${date.value}`
  ).then(()=>{
    item.value=qty.value=price.value=total.value="";
    toggleAddItem();
    loadItems();
  });
}
</script>

</body>
</html>
